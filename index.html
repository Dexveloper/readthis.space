<!DOCTYPE html>
<html lang="en">
<head>
    <title>ReadThis.Space</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A decentralized, throwaway authoring platform.">
    <meta property="og:title" content="ReadThis.Space">
    <meta property="og:description" content="A decentralized, throwaway authoring platform.">
    <meta property="og:site_name" content="ReadThis.Space">

    <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="manifest" href="/icons/site.webmanifest">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="/icons/favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="/icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

    <link rel="stylesheet" href="https://newcss.net/new.min.css">
    <script src="https://cdn.jsdelivr.net/npm/medium-editor@latest/dist/js/medium-editor.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/medium-editor@latest/dist/css/medium-editor.min.css" type="text/css" media="screen" charset="utf-8">
    <style>
        .meta { font-size: small; }
        #savedText {
            color: var(--nc-tx-2);
            background-color: var(--nc-bg-1);
            left: 0;
            right: 0;
            top: 0;
            position: fixed;
            text-align: center;
            opacity: 0;
        }
        .fadeInAndOut {
            -webkit-animation: fadeinout 2s ease-out forwards;
            animation: fadeinout 2s ease-out forwards;
        }
        @-webkit-keyframes fadeinout { 50% { opacity: 1; } }
        @keyframes fadeinout { 50% { opacity: 1; } }
    </style>
</head>

<body>
    <div id="app" style="display:none">
        <p id="savedText">Saved</p>
        <h1 id="title"></h1>
        <div class="meta"> 
            <p id="time" style="display:none;">Last Updated: <span id="lastUpdated"></span></p>
            <b><p id="author"></p></b>
        </div>
        <div id="content"></div>
        <hr>
        <p><button id="publishButton" onclick="publish()" style="display:none">üîó Create Link</button></p>
        <p><button id="deleteButton" onclick="deleteArticle(this)" style="float:right;background-color:#DF2935;display:none">üóëÔ∏è Delete</button></p>
        <p><button id="copyButton" onclick="copyLink(this)" style="display:none">üîó Copy Link</button></p>
        <p id="about" style="display:none"><small><i><a href="https://github.com/thrownness/readthis.space/blob/master/README.md">Learn more about readthis.space</a></i></small></p>
    </div>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/radix.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/radisk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/store.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/rindexed.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.0.11/dist/purify.min.js"></script>
<script>
    const peers = ['https://gun-us.herokuapp.com/gun','https://gun-eu.herokuapp.com/gun', 'https://gunjs.herokuapp.com/gun'];
    const gun = Gun({localStorage:false, peers:peers});
    const user = gun.user();
    const SEA = Gun.SEA;
    var myKeys = {};
    var urlPassword = '';
    var currentTitle = '';
    var hash = '';
    const savedTextEl = document.getElementById('savedText');

    function publish() {
        localStorage.setItem(myKeys.pub, JSON.stringify(myKeys));
        gun.get(`readthis.space#`).get(hash).put(myKeys.pub);
        var url = `?t=${encodeURIComponent(currentTitle.replace(/\s+/g, '-').toLowerCase())}&p=${encodeURIComponent(urlPassword)}#${hash}`
        history.pushState({},'', url);
        location.reload();
    }

    function copyLink(buttonElement) {
        navigator.clipboard.writeText(location.href).then(function() {
            buttonElement.innerText = 'Copied! üëç';
        }, function() {
            buttonElement.innerText = 'Copy permissions denied. üëé';
        });
    }

    function deleteArticle(buttonElement) {
        user.get('articles').get(hash).map().once((node, nodeID) => {
            user.get('articles').get(hash).get(nodeID).put(null);
        })
        localStorage.removeItem(myKeys.pub);
        buttonElement.innerText = 'Deleted! üëç';
    }

    function debounce(func, delay) {
        let inDebounce
        return function() {
            const context = this
            const args = arguments
            clearTimeout(inDebounce)
            inDebounce = setTimeout(() => func.apply(context, args), delay)
        }
    }

    async function save(event, editable) {
        savedTextEl.classList.remove('fadeInAndOut');
        void savedTextEl.offsetWidth;
        
        if (event.target.id === 'title') { currentTitle = editable.innerText }
        var encNode = await SEA.encrypt(editable.innerHTML, urlPassword)
        user.get('articles').get(hash).get(event.target.id).put(encNode)
        var encTime = await SEA.encrypt(new Date().toUTCString(), urlPassword)
        user.get('articles').get(hash).get('lastUpdated').put(encTime);

        savedTextEl.classList.add('fadeInAndOut');
    }
    
    async function go() {
        if (window.location.search) {
            urlPassword = decodeURIComponent(new URLSearchParams(window.location.search).get("p"));
            hash = window.location.hash.slice(1)
            var authorPubKey = await gun.get('readthis.space#').get(hash).once().then();
            gun.get(`~${authorPubKey}`).get('articles').get(hash).map().once(async (node, nodeID) => {
                var decNode = await SEA.decrypt(node, urlPassword);
                document.getElementById(nodeID).innerHTML = DOMPurify.sanitize(decNode);
            })
            document.getElementById('time').style.display = "";
            var localstorageKeyPair = localStorage.getItem(authorPubKey);
            if (localstorageKeyPair) {
                myKeys = JSON.parse(localstorageKeyPair);
                user.auth(myKeys);
                if (user.is) {
                    var editorTitle = new MediumEditor('#title', {placeholder: false, spellcheck: false, disableReturn: true,toolbar: false});
                    var editorAuthor = new MediumEditor('#author', {placeholder: false, spellcheck: false, disableReturn: true,toolbar: false});
                    var editorContent = new MediumEditor('#content', {placeholder: false, spellcheck: true});
                    editorTitle.subscribe('editableInput', debounce(save, 1000));
                    editorAuthor.subscribe('editableInput', debounce(save, 1000));
                    editorContent.subscribe('editableInput', debounce(save, 1000));
                    document.getElementById('deleteButton').style.display = "";
                }
            }
            document.getElementById('copyButton').style.display = "";
        } else {
            myKeys = await SEA.pair();
            urlPassword = SEA.random(11).toString();
            user.auth(myKeys);
            hash = await SEA.work(myKeys.pub, null, null, {name: "SHA-256"});
            if (user.is) {
                var editorTitle = new MediumEditor('#title', {placeholder: {
                    text: 'Title',
                    hideOnClick: false
                }, spellcheck: false, disableReturn: true,toolbar: false});
                var editorAuthor = new MediumEditor('#author', {placeholder: {
                    text: 'Your name',
                    hideOnClick: false
                }, spellcheck: false, disableReturn: true,toolbar: false});
                var editorContent = new MediumEditor('#content', {placeholder: {
                    text: 'Your story...',
                    hideOnClick: false
                }, spellcheck: true});
                editorTitle.subscribe('editableInput', debounce(save, 1000));
                editorAuthor.subscribe('editableInput', debounce(save, 1000));
                editorContent.subscribe('editableInput', debounce(save, 1000));
                document.getElementById('publishButton').style.cssText = "";
                document.getElementById('about').style.cssText = "";
            }
        }
        document.getElementById('app').style.cssText = "";
    }
    go();
</script>
</body>
</html>
